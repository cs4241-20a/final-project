<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="style.css" />

    <title>Document</title>
  </head>

  <body>
    <div class="navbar">
      <div class="dropdown" id="setMenu">
        <button class="dropbtn">
          <i class="fa fa-cog fa-lg allText"></i>
        </button>
        <div class="dropdown-content accentElement">
          <a href="/auth">Log In</a> <!--Once user logs in and is authenticated, add function to change Log In to Log Out-->
          <a onclick = "showColorPicker(0)">
            Background Color
          </a>
          <a onclick = "showColorPicker(1)">Primary Color</a>
          <a onclick = "showColorPicker(2)">Accent Color</a>
          <a onclick = "showColorPicker(3)">Text Color</a>
        </div>
      </div>

      <p class="greeting allText">
        hello, world!
      </p>
      <div>
      <button class="saveBtn allText"> <!--to be implemented onclick, should save all changes and send to database--->
        Save Changes
      </button>
      <div class="dropdown" id="addCat">
        <button class="dropbtn allText">
          Add Category
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content accentElement" id="rightContent">
          <a onclick="genTextCard('test', 'this is a test', 'fds8a89')">Text</a>
          <a onclick = "genToDoBox('todo', 'this is a test')">Todo</a>
          <a onclick = "genBookmarksBox('bookmarks', 'this is a test')">Bookmarks</a>
        </div>
      </div>
    </div>
    </div>
    <h1></h1>
    
    <!-- putting the picker in a card that toggles with the background color button -->
    <div id = "bgColorCard" class = "card primaryElement" hidden>
      <div class = "container">
        <button class="button" id="closeBtn" onclick = "hideColorPicker()">
                <i class="fa fa-times-circle fa-lg"></i>
              </button>
        <h4>
          <b id = "colorPickerTitle" class = "allText">Set Background Color</b>
          <p>
             <div id="picker"></div>
              <button class="button accentElement" id="setbgcolor">
                Set Color
              </button>
              <button class="button accentElement" id="reset">
                Reset
              </button>         
          </p>
        </h4>
      </div>
    </div>


    <div class="card primaryElement">
        <div id="cardsheader">&nbsp;</div>
        <div class="container">
          <h4 contenteditable="true" class = "allText"><b>Card Title</b></h4>
          <p contenteditable="true" class = "allText">Card Test</p>
        </div>
      </div>
    </div>
    <!--Drag and drop API: https://api.jqueryui.com/draggable/-->

    
  
    
  
  </body>

  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
  <script>
    window.onload = () => {};
    

    
    var pickerType = 0; //variable stores what kind of color picker to display. 0=background 1=primary 2=accent 3=text

    var colorPicker = new iro.ColorPicker("#picker", {
      width: 150
    });

    var body = document.querySelector("body");
    var setbg = document.getElementById("setbgcolor");
    var reset = document.getElementById("reset");

    reset.onclick = function() {
    
      switch(pickerType){
          case 0:
            //background
            body.style.backgroundColor = "white";
            break;
          case 1:
            //primary
            var elem = document.getElementsByClassName("primaryElement");          
            for (var i = 0; i < elem.length; i++){
              elem[i].style.backgroundColor = "white";
            }
            break;
          case 2:
            //accent
             var elem = document.getElementsByClassName("accentElement");          
            for (var i = 0; i < elem.length; i++){
              elem[i].style.backgroundColor = "white";
            }
            break;
          case 3:
            //text
            var elem = document.getElementsByClassName("allText");          
            for (var i = 0; i < elem.length; i++){
              elem[i].style.color = "black";
            }
            break;
        }  
    };

    colorPicker.on("color:change", function(color) {
      setbg.onclick = function() {
  
        switch(pickerType){
          case 0:
            //background
            body.style.backgroundColor = colorPicker.color.hexString;
            break;
          case 1:
            //primary
            var elem = document.getElementsByClassName("primaryElement");          
            for (var i = 0; i < elem.length; i++){
              elem[i].style.backgroundColor = colorPicker.color.hexString;
            }
            break;
          case 2:
            //accent
            var elem = document.getElementsByClassName("accentElement");          
            for (var i = 0; i < elem.length; i++){
              elem[i].style.backgroundColor = colorPicker.color.hexString;
            }
            break;
          case 3:
            //text
            var elem = document.getElementsByClassName("allText");          
            for (var i = 0; i < elem.length; i++){
              elem[i].style.color = colorPicker.color.hexString;
            }
            break;
        }      
        
      };
    });

    // Function should be implemented to log error in html
    //Function runs when error occurs like user not being logged in
    function logError(error) {
      console.warn(error); //place holder
    }

    // Function returns object of settings.
    // Empty if not logged in or settings dont exist
    function getSettings() {
      let settings = {};

      fetch("/settings")
        .then(res => res.json())
        .then(json => {
          if (!json.error) {
            settings = json;
          } else {
            logError(json.error);
          }
        });

      return settings;
    }

    //Function creates or updates settings also returns settings.
    // MUST include all params
    function createOrUpdateSettings(
      backgroundColor,
      primaryColor,
      accentColor,
      fontColor
    ) {
      let settings = {};

      fetch("/updatesettings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          backgroundColor,
          primaryColor,
          accentColor,
          fontColor
        })
      })
        .then(res => res.json())
        .then(json => {
          if (!json.error) {
            settings = json;
          } else {
            logError(json.error);
          }
        });

      return settings;
    }

    // Function returns list of box objects.
    // Empty if not logged in or settings dont exist
    function getBoxes() {
      let boxes = [];

      fetch("/data")
        .then(res => res.json())
        .then(json => {
          if (!json.error) {
            boxes = json;
          } else {
            logError(json.error);
          }
        });
      loadBoxesToPage(boxes);
      return boxes;
    }

    // Function adds a box
    // title: is a string
    // PosX and PosY:  is a number
    // type: should be specific strings ('todo','text','link')
    // items: is a list/array of whatever you want
    // also returns boxes
    function addBox(title, posX, posY, type, items) {
      let boxes = [];

      fetch("/add", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          title,
          posX,
          posY,
          type,
          items
        })
      })
        .then(res => res.json())
        .then(json => {
          if (!json.error) {
            boxes = json;
          } else {
            logError(json.error);
          }
        });

      //add the element to the page
      loadBoxesToPage(boxes);
      return boxes;
    }


    // Function updates a box. use all params
    // Returns updated boxes
    function updateBox(_id, title, posX, posY, type, items) {
      let boxes = [];

      fetch("/update", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          _id,
          title,
          posX,
          posY,
          type,
          items
        })
      })
        .then(res => res.json())
        .then(json => {
          if (!json.error) {
            boxes = json;
          } else {
            logError(json.error);
          }
        });
      loadBoxesToPage(boxes);
      return boxes;
    }

    //Function deletes entire box
    // also returns boxes
    function deleteBox(_id) {
      let boxes = [];

      fetch("/remove", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          _id
        })
      })
        .then(res => res.json())
        .then(json => {
          if (!json.error) {
            boxes = json;
          } else {
            logError(json.error);
          }
        });
      loadBoxesToPage(boxes);
      return boxes;
    }
    
    function loadBoxesToPage(boxes){
      const tempBoxes = boxes;
      tempBoxes.forEach(box => {
        if (box.type === 'text'){
          genTextBox(box.title, box.items);
        }
        else if (box.type === 'todo'){
          genToDoBox(box.title, box.items);
        }
        else if (box.type === 'link'){
          genBookmarksBox(box.title, box.items);
        }
        else {
          console.log("invalid box type. cannot generate box");
        }
      });
    }

    //generates a new text card
    function genTextCard(title, description, _id){

      const newDiv = document.createElement("div"); 
      newDiv.id = _id
      newDiv.className = "card primaryElement";

      //var cards = document.getElementById("cards");
      newDiv.innerHTML += `
          <div id="${_id}header">&nbsp;</div>
          <div class="container">
            <h4 contenteditable="true" class = "allText"><b>${title}</b></h4>
            <p contenteditable="true" class = "allText">${description}</p>
          </div>
        `;


      dragElement(newDiv);
      document.body.appendChild(newDiv); 
      
      //dummy values for posX and posY for now
      addBox(title, 0, 0, "Text", description);
    
  }
    
  
    
    function genToDoBox(title, items){
      // to be finished later
      const newToDo = document.createElement("div"); 
      newToDo.className = "card primaryElement";

      //var cards = document.getElementById("cards");
      newToDo.innerHTML += `
          <div id="cardsheader">&nbsp;</div>
          <div class="container">
            <h4 contenteditable="true" class = "allText"><b>${title}</b></h4>
            <ul contenteditable="true" class = "allText"><li>${items}<li></ul>
          </div>
        `;


      dragElement(newToDo);
      document.body.appendChild(newToDo); 
      
      //dummy values for posX and posY for now
      addBox(title, 0, 0, "ToDo", items);
    }
    
    function genBookmarksBox(title, link){
      const newDiv = document.createElement("div"); 
      newDiv.className = "card primaryElement";

      //var cards = document.getElementById("cards");
      newDiv.innerHTML += `
          <div id="cardsheader">&nbsp;</div>
          <div class="container">
            <h4 contenteditable="true" class = "allText"><b>${title}</b></h4>
            <ul> <li class = "allText">${link}</li></ul>
          </div>
        `;


      dragElement(newDiv);
      document.body.appendChild(newDiv); 
      
      //dummy values for posX and posY for now
      addBox(title, 0, 0, "Bookmarks", link);
    }
    
    //hide and show the color picker
    function showColorPicker(type){
      //set the type of the color picker
      pickerType = type;
      var elem = document.getElementById("bgColorCard");
      //also should change the name of the picker
      var title = document.getElementById("colorPickerTitle");
      switch(pickerType){
        case 0:
          //background
          title.innerHTML = "Set Background Color";
          break;
        case 1:
          //card
          title.innerHTML = "Set Primary Color";
          break;
        case 2:
          //accent elements
          title.innerHTML = "Set Accent Color";
          break;
        case 3:
          //text
          title.innerHTML = "Set Text Color";
          break;
      }
          
      elem.hidden = false;
    }
    
    function hideColorPicker(){
      var elem = document.getElementById("bgColorCard");
      elem.hidden = true;
    }





    // Make the DIV element draggable:
var draggableElements = document.getElementsByClassName("card");

for(var i = 0; i < draggableElements.length; i++){
    dragElement(draggableElements[i]);
}

function dragElement(elmnt) {
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  if (document.getElementById(`${elmnt.id}header`)) {
    // if present, the header is where you move the DIV from:
    document.getElementById(`${elmnt.id}header`).onmousedown = dragMouseDown;
  } else {
    // otherwise, move the DIV from anywhere inside the DIV:
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}


// When the user scrolls the page, execute myFunction
window.onscroll = function() {myFunction()};

// Get the navbar
var navbar = document.getElementById("navbar");

// Get the offset position of the navbar
var sticky = navbar.offsetTop;

// Add the sticky class to the navbar when you reach its scroll position. Remove "sticky" when you leave the scroll position
function myFunction() {
  if (window.pageYOffset >= sticky) {
    navbar.classList.add("sticky")
  } else {
    navbar.classList.remove("sticky");
  }
}
  </script>
</html>
